import time
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
from bs4 import BeautifulSoup
from urllib.parse import quote
from selenium.common.exceptions import NoSuchElementException, TimeoutException, WebDriverException

def get_naver_blog_titles_multiple_pages(ingredient, max_pages=3):
    """Seleniumì„ ì‚¬ìš©í•˜ì—¬ ë„¤ì´ë²„ ë¸”ë¡œê·¸ì—ì„œ ë ˆì‹œí”¼ ê´€ë ¨ ê²Œì‹œê¸€ ì œëª©ê³¼ URL í¬ë¡¤ë§"""

    # âœ… Chrome WebDriver ì„¤ì •
    chrome_options = Options()
    chrome_options.add_argument("--headless")  # ğŸš€ GUI ì—†ì´ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ ëª¨ë“œ)
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--window-size=1920x1080")  # âœ… í•´ìƒë„ ì„¤ì • (UI ê¹¨ì§ ë°©ì§€)

    # âœ… WebDriverManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ChromeDriver ì„¤ì¹˜ ìµœì í™”
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=chrome_options)
    wait = WebDriverWait(driver, 5)  # âœ… ëŒ€ê¸° ì‹œê°„ì„ 5ì´ˆë¡œ ì„¤ì • (ìµœì í™”)

    # âœ… ê²€ìƒ‰ì–´ë¥¼ URL ì¸ì½”ë”©í•˜ì—¬ ì²« ë²ˆì§¸ í˜ì´ì§€ URL ì„¤ì •
    encoded_ingredient = quote(ingredient)
    base_url = f"https://section.blog.naver.com/Search/Post.naver?keyword={encoded_ingredient}+ë ˆì‹œí”¼"
    driver.get(base_url)

    blog_data = []  # (ì œëª©, URL) ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    previous_url = ""  # âœ… ì¤‘ë³µ ìš”ì²­ ë°©ì§€ë¥¼ ìœ„í•œ URL ì €ì¥

    try:
        for page in range(1, max_pages + 1):
            print(f"\nğŸ” [í¬ë¡¤ë§ ì¤‘: {page} í˜ì´ì§€]")

            # âœ… ì¤‘ë³µ í˜ì´ì§€ í¬ë¡¤ë§ ë°©ì§€
            if driver.current_url == previous_url:
                print("âš ï¸ ë™ì¼í•œ í˜ì´ì§€ê°€ ë°˜ë³µ í˜¸ì¶œë¨. í¬ë¡¤ë§ ì¢…ë£Œ.")
                break
            previous_url = driver.current_url

            # âœ… í˜ì´ì§€ê°€ ì™„ì „íˆ í‘œì‹œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            try:
                wait.until(EC.visibility_of_element_located((By.CSS_SELECTOR, "span.title")))
            except TimeoutException:
                print("âš ï¸ í˜ì´ì§€ ë¡œë”©ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. í¬ë¡¤ë§ ì¢…ë£Œ.")
                break

            # âœ… BeautifulSoupì„ ì‚¬ìš©í•˜ì—¬ ì œëª©ê³¼ URL í•¨ê»˜ í¬ë¡¤ë§
            soup = BeautifulSoup(driver.page_source, "html.parser")
            posts = soup.select(".title_area")
            for post in posts:
                title = post.select_one("span.title").get_text(strip=True)
                link = post.find_parent("a")["href"]
                blog_data.append((title, link))

            # âœ… ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ (ë¹„í™œì„±í™” í™•ì¸ í›„ í´ë¦­)
            try:
                page_button = driver.find_element(By.XPATH, '//a[contains(@class, "btn_next")]')
                if "disabled" in page_button.get_attribute("class"):
                    print("âš ï¸ ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. í¬ë¡¤ë§ ì¢…ë£Œ.")
                    break
                driver.execute_script("arguments[0].click();", page_button)
                wait.until(EC.staleness_of(page_button))  # âœ… ìƒˆ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            except NoSuchElementException:
                print("âš ï¸ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤. í¬ë¡¤ë§ ì¢…ë£Œ.")
                break
            except WebDriverException as e:
                print(f"âš ï¸ ì›¹ë“œë¼ì´ë²„ ì˜¤ë¥˜ ë°œìƒ: {e}")
                break
            except Exception as e:
                print(f"âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")
                break

    finally:
        if driver:
            driver.quit()  # ğŸš€ ë¬´ì¡°ê±´ WebDriver ì¢…ë£Œ (ì•ˆì •ì„± ê°•í™”)

    return blog_data if blog_data else [("íŠ¸ë Œë“œ ì—†ìŒ", "N/A")]

# ğŸš€ ì‹¤í–‰
result = get_naver_blog_titles_multiple_pages("ê¹€ì¹˜", max_pages=3)

# ğŸ“Œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ë¡¤ë§ ê²°ê³¼ ì¶œë ¥
print("\nğŸ“Œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ë¡¤ë§ ê²°ê³¼:")
for title, link in result:
    print(f"ğŸ“ {title} - {link}")
